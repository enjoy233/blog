<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 用 Raspberry Pi 做 NAS 和 采集器 | TaoAlpha's Blog</title><meta name="description" content="本篇为树莓派折腾系列的第二篇, 主要介绍下如何用树莓派制作一个简单的采集器, 也就是自用的网络小爬虫; 另外也顺带介绍下如何把树莓派建立成一个简易的 NAS."><meta name="viewport" content="width=device-width, initial-scale=1"><!-- open graph part--><meta property="og:title" content="用 Raspberry Pi 做 NAS 和 采集器 | TaoAlpha's Blog"><meta property="og:description" content="本篇为树莓派折腾系列的第二篇, 主要介绍下如何用树莓派制作一个简单的采集器, 也就是自用的网络小爬虫; 另外也顺带介绍下如何把树莓派建立成一个简易的 NAS."><meta property="og:url" content="undefined"><meta property="og:image" content="http://taoalpha.github.io/images/newblog.jpg"><meta property="og:type" content="website"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.0.0/animate.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.6.0/hint.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.1/css/all.min.css"><link rel="short icon" href="/blog/favicon.png"><link rel="stylesheet" href="/blog/css/default.css"><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/blog/atom.xml" title="TaoAlpha's Blog" type="application/atom+xml">
<link rel="alternate" href="/blog/rss2.xml" title="TaoAlpha's Blog" type="application/rss+xml">
</head><body class="post"><aside class="home-menu"><nav class="home-icon-con upside"><a href="/blog/" class="home-menu-icon brand">涛</a><a href="/blog/timeline" class="home-menu-icon"><i class="fas fa-map-marker-alt"></i></a><a aria-label="Click to take you to the search box." class="home-menu-icon search-trigger hint--right"><i class="fas fa-search"></i></a><a href="javascript:;" title="Contact Me" class="home-menu-icon follow">+</a><div class="home-contact hidden"><a href="https://facebook.com/zzgary/" target="something"><img src="https://cdn1.iconfinder.com/data/icons/social-shade-rounded-rects/512/facebook-32.png" alt="facebook"></a><a href="https://github.com/taoalpha/" target="something"><img src="https://cdn1.iconfinder.com/data/icons/social-shade-rounded-rects/512/github-32.png" alt="github"></a><a href="https://taoalpha.github.io" target="something"><img src="https://cdn3.iconfinder.com/data/icons/colore-sociale/32/mewally_32x32.png" alt="portfolio"></a><a href="https://douban.com/people/129154019" target="something"><img src="https://img3.doubanio.com/favicon.ico" alt="douban"></a></div></nav><nav class="home-icon-con downside"><a href="/blog/rss2.xml" class="home-menu-icon rss"><i class="fas fa-rss"></i></a><a href="/blog/about/" class="home-menu-icon"><i class="fas fa-smile"></i></a><span id="dark-mode" class="home-menu-icon hidden"><i class="fas fa-adjust"></i></span></nav></aside><div class="stars"></div><div class="twinkling"></div><div id="progress-bar" class="hidden"><span class="bg"></span></div><article id="content"><div class="main"><section class="entry"><h1 class="entry-title">用 Raspberry Pi 做 NAS 和 采集器</h1><div class="meta-top"><a href="https://taoalpha.github.io"><div style="display:inline-block;" class="avatar"><img src="https://avatars3.githubusercontent.com/u/4335753?v=3&amp;s=40" alt="100"></div><span>TaoAlpha</span></a><span>2015-08-20</span><span class="wordage">4720 words</span><span class="readspeed">14 minutes to read</span></div><div class="entry-content"><h2 id="引子"><a href="#引子" class="headerlink" title="引子"></a>引子</h2><p>在之前<br><a href="/blog/2015/07/05/tech-raspberry-pi-setup/">Raspberry Pi Setup</a>一文中介绍了树莓派的初始配置. 这几天乘着还没开学, 就赶紧把树莓派重新跑起来, 虽然悲催的因为网络设定导致我的树莓派无法联网只能强制重刷了… 好在之前在家里就一直用 samba 把重要的脚本都存在了外置盘上, 而已抓取的数据也有早起的备份, 丢失的数据就没办法了..</p>
<p>所以正好相当于重新设定了一遍 NAS 和 diango , 本文做简单介绍, 方便后续查看.</p>
<h2 id="NAS"><a href="#NAS" class="headerlink" title="NAS"></a>NAS</h2><p>NAS 全称是: Network-attached Storage. 简单说就是在一个网络组中用来存储数据的地方, 而在这个网路组的所有用户都可以在相应的权限下查看, 编辑.</p>
<p>通常一个低配的 NAS 也要差不多100多刀左右, 当然其读写速度, 性能都是很棒的, 买来即用~ 不过作为穷屌丝一枚, 手头又有几个闲置的移动硬盘和 U 盘. 于是就参考网上的教程用树莓派做个简易的 NAS , 供个人和室友使用还是绰绰有余了~</p>
<h3 id="Samba"><a href="#Samba" class="headerlink" title="Samba"></a>Samba</h3><p>想要实现自用的 NAS, 主要依赖的就是 Samba 这个服务了. Samba 是基于 SMB 协议的一个服务. 利用它多平台的特性可以方便的在多平台上进行数据交换. 而自建 NAS 的核心即是: 以树莓派为搭载平台, 将链接其上的闲置硬盘作为共用存储器.</p>
<p>Samba 的安装和配置都很简单:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">apt-get install samba samba-common-bin</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改 /etc/samba/smb.conf 开启安全权限, 取消 `security = user`的注释即可</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里主要是确保samba 的用户必须是系统的用户之一</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 然后添加下面内容到 /etc/samba/smb.conf 中</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[public]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">此处把公共盘的名字设定为了 public, 可以修改</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  comment = Public Storage</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  备注名</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  path = /nas</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  path 选择自己挂载硬盘的位置, 初始应该是/dev/sdan 这种格式的, 可以通过 `mount /dev/sdan /newpath`来修改;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  valid users = pi nas</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  分配用户权限, 这里给予了 pi 和 nas 两个用户的访问权限</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  <span class="built_in">read</span> only = no</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  create mask = 0777</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  public = yes</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  writable = yes</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  directory mask = 0777</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  guest ok = yes</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  browseable = yes</span></span><br></pre></td></tr></table></figure>

<p>其中, 如果希望每次开机自动挂载硬盘到自定义位置, 可以通过修改<code>/etc/fstab</code>文件来实现:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">在原有基础上添加(修改 `/sda1` 为你的硬盘初始挂载位置):</span></span><br><span class="line">/dev/sda1       /nas            ext4    defaults          0       0</span><br></pre></td></tr></table></figure>
<p>在完成设定后, 就需要重启 samba 服务并添加对应用户了. 因为我们开启了<code>security = user</code>, 所以这里需要给 samba 添加系统用户, 比如默认的 pi 用户, 或者 root. 当然你可以通过<code>useradd</code>来给系统创建新用户.</p>
<p>创建用户后, 就可以给 samba 添加用户了.</p>
<p><code>smbpasswd -a username</code> 即可添加用户, <code>smbpasswd -e nas</code> 则启用此用户.</p>
<p>设定好对应用户的 samba 密码后即可通过你的电脑访问你的共享盘了, 你可以通过 connect 到 <code>smb://192.168.x.x</code>(你的 pi 地址), 然后输入对应的用户名密码即可~</p>
<p>PS. 如果你是用的 NTFS 的硬盘, 那么还需要安装<code>ntfs-3g</code>来实现对硬盘的读写功能, 如果你用的是 mac 的盘, 那么还需要安装<code>hfsplus</code>和<code>hfsutils</code>来实现同样的目的~ 上述都可以通过<code>apt-get</code>直接安装.</p>
<p>到此, 你的简易 nas 就算是完成了~ 可以享受喽~</p>
<h2 id="采集器"><a href="#采集器" class="headerlink" title="采集器"></a>采集器</h2><p>玩 python, 怎么能不写爬虫呢? 哈哈 因为树莓派低功耗, 全天候运行的特性, 作为爬虫可谓是绝佳的好平台 ^_^</p>
<h3 id="支持库安装"><a href="#支持库安装" class="headerlink" title="支持库安装"></a>支持库安装</h3><p>首先为了跟随时代潮流, 我选择3.4作为 python 主版本~ 2.7.6作为辅助. 这里可以通过<a href="https://github.com/utahta/pythonbrew" target="_blank" rel="noopener">Pythonbrew</a>来实现轻松管理 python 版本的目的. (注: pythonbrew 安装3.4的时候要使用3.4.0这种具体到小版本号的名称安装, 不然会找不到 package 的)</p>
<p>3.4已经自带了pip, 所以就可以不用自己安装了~ 接下来利用 pip 来安装支持库.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pip install django</span><br><span class="line"><span class="meta">#</span><span class="bash"> 我比较习惯django 的框架了, 如果你喜欢 flask 也可以根据自己的喜好调整</span></span><br><span class="line">pip install beautifulsoup4</span><br><span class="line"><span class="meta">#</span><span class="bash"> html 解析库, 当然, 你也可以利用 xpath 来硬解~</span></span><br><span class="line">pip install mysqlclient</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个是 MySQLdb的一个 fork, 但是提供了 python3的支持, 用来修复支持 p3 下 django 使用 mysql .</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果上述报mysql 的错误或者mysql_config not found, 请确保你已经安装了 mysql 以及 libmysqlclient-dev</span></span><br><span class="line">pip install pymysql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 习惯用这个做抓去插入了... 可以用 MySQLdb 的~</span></span><br><span class="line">pip install git+ssh://git@github.com/Supervisor/supervisor.git</span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为 supervisor 在 pip 的版本不支持 p3, 所以需要自己直接利用 pip 安装 git 上的版本.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 需要先添加 sshkey 到 github 上, 不然无法 <span class="built_in">clone</span> 的~ 相关请查看 github 官方介绍.</span></span><br></pre></td></tr></table></figure>

<p>到此, 基本库就算是差不多全了.</p>
<h3 id="django"><a href="#django" class="headerlink" title="django"></a>django</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">django-admin startproject PROJECT_NAME</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建新项目</span></span><br><span class="line">django-admin startapp APP_NAME</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建新 app</span></span><br></pre></td></tr></table></figure>

<p>修改 project 里的 <code>settings.py</code>, 替换 database 的配置(根据你是用的 db 库修改), 添加 APP_NAME 到 INSTALLED_APPS 里.</p>
<h3 id="采集APP"><a href="#采集APP" class="headerlink" title="采集APP"></a>采集APP</h3><p>根据自己的情况修改 APP 的 <code>models.py</code> 创建表结构.</p>
<p>同步数据库:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">python manage.py migrate</span><br><span class="line"><span class="meta">#</span><span class="bash"> 同步 django 的数据库</span></span><br><span class="line">python manage.py makemigrations APP_NAME</span><br><span class="line"><span class="meta">#</span><span class="bash"> APP 表结构迁移</span></span><br><span class="line">python manage.py sqlmigrate crawlers 000x</span><br><span class="line"><span class="meta">#</span><span class="bash"> APP SQL 迁移(可以预览下 SQL). 这里的000x 是根据上一步 makemigrations 得到的 version 编码, 一致即可</span></span><br><span class="line">python manage.py migrate</span><br><span class="line"><span class="meta">#</span><span class="bash"> 同步数据库, 正式生效</span></span><br></pre></td></tr></table></figure>

<p>此外, 记得创建一个 admin user 并且把 admin 的静态文件转移过来~ (需要在 project 的 settings.py 中设定<code>STATIC_ROOT</code>路径)</p>
<p><code>python manage.py createsuperuser</code></p>
<p><code>python manage.py collectstatic</code></p>
<p>通过这个就可以登录 django 的 admin 后台了~</p>
<h3 id="采集脚本"><a href="#采集脚本" class="headerlink" title="采集脚本"></a>采集脚本</h3><p>接下来就是数据库的填充了~ 这里就得根据自己的情况来写爬虫喽~</p>
<h3 id="supervisor-自启动"><a href="#supervisor-自启动" class="headerlink" title="supervisor 自启动"></a>supervisor 自启动</h3><p>supervisor 是很好的系统任务管理工具. 利用它可以更方便的管理我们的 django 以及其他的项目, 如果有的话.</p>
<p>上面安装支持库中已经成功的为 python 3 安装了 supervisor, 所以这里我们就可以直接进入到配置环节了:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[supervisord]</span><br><span class="line">[program:pragram_name]</span><br><span class="line">directory&#x3D;path_to_django_project</span><br><span class="line">command&#x3D;python manage.py runserver</span><br><span class="line">autorestart&#x3D;true</span><br><span class="line">autostart&#x3D;true</span><br></pre></td></tr></table></figure>

<p>DONE! 保存这一配置文件到你的任意目录中, 只要记得启动<code>supervisord</code>的时候利用<code>-c</code>指定到这一配置文件即可.</p>
<h3 id="nginx-映射"><a href="#nginx-映射" class="headerlink" title="nginx 映射"></a>nginx 映射</h3><p>为了让我们能够在局域网的其他机器上直接访问我们的 django, 我们需要把 nginx 映射到我们的 django 去~</p>
<p>最简单的方法就是, 利用<code>proxy_pass http://127.0.0.1:8000;</code>将80端口直接导向我们的 django server 所在.</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>   <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    <span class="attribute">access_log</span>  /var/log/nginx/access.log;</span><br><span class="line">    <span class="attribute">error_log</span> /var/log/nginx/error.log <span class="literal">debug</span>;</span><br><span class="line">    <span class="attribute">rewrite_log</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://127.0.0.1:8000;</span><br><span class="line">        <span class="attribute">proxy_redirect</span>  <span class="literal">off</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> /static/ &#123;</span><br><span class="line">        <span class="attribute">root</span> path_to_project;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 如此, 通过 <code>supervisord -c path_to_supervisor_conf</code> 就可以启动你的 django 了~ 稍等片刻, 你就可以通过访问你的树莓派 ip 看到成功搭建的 django 欢迎页面了~</p>
<p>PS. 如果不喜欢手动加载 supervisor 配置, 也可以把配置文件放到 supervisor 的系统配置目录中, 然后就可以通过<code>supervisord  start supervisor_program_name</code>来启动了~</p>
<p>恩, 就到这里了~ 下一步就是在我的树莓派上搭建一个每天任务跟踪的服务了~ 这个还需要好好想想~ ^_^</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://docs.djangoproject.com/en/1.8/intro/" target="_blank" rel="noopener">django Getting started</a></li>
<li><a href="https://github.com/PyMySQL/mysqlclient-python" target="_blank" rel="noopener">MySQL database connector for Python (with Python 3 support)</a></li>
<li><a href="http://stackoverflow.com/questions/4830856/is-it-possible-to-use-pip-to-install-a-package-from-a-private-github-repository" target="_blank" rel="noopener">pip install from git repo</a></li>
<li><a href="http://stackoverflow.com/questions/7475223/mysql-config-not-found-when-installing-mysqldb-python-interface" target="_blank" rel="noopener">mysql_config not found when installing mysqldb python interface</a></li>
</ul>
</div><div class="post-info"><span class="category"><i class="fas fa-briefcase"></i><a href="/blog/categories/tech">tech</a></span><span class="tags"><i class="fas fa-tags"></i><a href="/blog/tags/Raspberry-Pi">Raspberry Pi</a><a href="/blog/tags/NAS">NAS</a><a href="/blog/tags/Crawler">Crawler</a></span></div></section><div class="widgets"><aside id="menuIndex" class="sidenav hidden"></aside><aside class="sidenav"><input type="text" placeholder="Enter to search" class="st-default-search-input searchbox"></aside><aside class="sidenav series"><h2>In Serie: The Way I learn Pi<i class="fas fa-arrow-down expand"></i><i class="collapse fas fa-arrow-up"></i></h2><ul class="article-list hidden"><li><a href="/blog/2015/07/05/tech-raspberry-pi-setup/" data-id='0'>Raspberry Pi Setup</a></li><li><a href="/blog/2015/08/20/tech-raspberry-pi-as-nas-and-crawlers/" data-id='1' class="current">用 Raspberry Pi 做 NAS 和 采集器</a></li></ul></aside><aside class="sidenav"><div class="recent-posts"><h2>Recent Posts:</h2><ul class="article-list"><li><a href="/blog/2020/07/06/thoughts-recommendation-to-new-grads-on-job-choices/">给新计算机毕业生在工作选择上的一些建议</a></li><li><a href="/blog/2020/07/04/travel-working-holiday-visa-3/">打工度假 (三)</a></li><li><a href="/blog/2020/07/02/travel-working-holiday-visa-2/">打工度假 (二)</a></li><li><a href="/blog/2020/07/02/tech-what-i-have-done-to-restart-this-blog/">我都做了哪些来复活本博客的</a></li><li><a href="/blog/2020/07/01/travel-working-holiday-visa/">打工度假 (一)</a></li></ul></div></aside></div></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/default.css"><script src="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/gitment.browser.js"></script><div class="comments"><script>const gitment = new Gitment({
  id: new Date('Thu Aug 20 2015 06:00:00 GMT-0400').toISOString(),
  owner: 'taoalpha',
  repo: 'blog',
  oauth: {
    client_id: '875872ffb3955d0ffe20',
    client_secret: '46040668c536860a9e2e9a8508c513309e3840b5',
  },
});
gitment.render(document.querySelector('.comments'));
</script></div></article><div class="notification fail hidden"></div><!-- jquery--><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-46725017-2",'auto');ga('send','pageview');</script><script>(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
_st('install','CUMLELEvkSRAFuVehSCm','2.0.0');</script><!-- main functions--><script src="/blog/js/functions.js"></script><script src="/blog/js/default.js"></script><script src="/blog/js/post.js"></script></body></html>